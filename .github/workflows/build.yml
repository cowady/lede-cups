name: Build CUPS + AirPrint for WNDR4300

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build OpenWrt packages for WNDR4300

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib gettext git libncurses-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget libelf-dev ecj fastjar java-propose-classpath libglib2.0-dev

    - name: Clone OpenWrt
      run: |
        git clone https://github.com/openwrt/openwrt.git
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Add CUPS and AirPrint packages
      run: |
        cd openwrt/package
        git clone https://github.com/openwrt/packages temp-packages
        cp -r temp-packages/print/cups .
        cp -r temp-packages/print/cups-filters .
        cp -r temp-packages/net/avahi .
        rm -rf temp-packages

    - name: Configure target
      run: |
        cd openwrt
        echo "CONFIG_TARGET_ath79=y" > .config
        echo "CONFIG_TARGET_ath79_nand=y" >> .config
        echo "CONFIG_TARGET_ath79_nand_DEVICE_wndr4300=y" >> .config
        echo "CONFIG_PACKAGE_cups=y" >> .config
        echo "CONFIG_PACKAGE_cups-filters=y" >> .config
        echo "CONFIG_PACKAGE_avahi-daemon=y" >> .config
        echo "CONFIG_PACKAGE_avahi-dnsconfd=y" >> .config
        echo "CONFIG_PACKAGE_avahi-utils=y" >> .config
        make defconfig

    - name: Build packages
      run: |
        cd openwrt
        make package/cups/compile V=s
        make package/cups-filters/compile V=s
        make package/avahi/compile V=s

    - name: Archive IPK files
      run: |
        mkdir -p output
        find openwrt/bin/packages/ -name "*.ipk" -exec cp {} output/ \;
        cd output
        zip -r ../cups-airprint-packages.zip .

    - name: Upload Release Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cups-airprint-packages
        path: cups-airprint-packages.zip
