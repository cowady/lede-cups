name: Build CUPS for WNDR4300

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            python3 python3-pip unzip zlib1g-dev file wget python3-setuptools \
            rsync libelf-dev ccache

      - name: Checkout OpenWrt source
        run: |
          git clone https://github.com/openwrt/openwrt.git
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add packages for CUPS and AirPrint
        run: |
          cd openwrt
          echo "CONFIG_PACKAGE_cups=y" >> .config
          echo "CONFIG_PACKAGE_cups-daemon=y" >> .config
          echo "CONFIG_PACKAGE_cups-filters=y" >> .config
          echo "CONFIG_PACKAGE_cups-common=y" >> .config
          echo "CONFIG_PACKAGE_avahi-daemon=y" >> .config
          echo "CONFIG_PACKAGE_avahi-dnsconfd=y" >> .config
          echo "CONFIG_PACKAGE_avahi-autoipd=y" >> .config
          echo "CONFIG_PACKAGE_libavahi-client=y" >> .config
          echo "CONFIG_PACKAGE_libavahi-common=y" >> .config
          echo "CONFIG_PACKAGE_libavahi-dbus-support=y" >> .config
          echo "CONFIG_PACKAGE_libcups=y" >> .config
          echo "CONFIG_PACKAGE_libgnutls=y" >> .config
          echo "CONFIG_PACKAGE_libgcrypt=y" >> .config
          echo "CONFIG_PACKAGE_libgpg-error=y" >> .config
          echo "CONFIG_PACKAGE_libcap=y" >> .config
          echo "CONFIG_PACKAGE_libdaemon=y" >> .config
          echo "CONFIG_PACKAGE_libdbus=y" >> .config
          echo "CONFIG_PACKAGE_zlib=y" >> .config

          make defconfig

      - name: Build selected packages only
        run: |
          cd openwrt
          make package/cups/compile -j$(nproc) V=s
          make package/cups-filters/compile -j$(nproc) V=s
          make package/avahi-daemon/compile -j$(nproc) V=s

      - name: Upload compiled IPK
        uses: actions/upload-artifact@v4
        with:
          name: cups-and-airprint-packages
          path: openwrt/bin/packages/**/cups*.ipk
